#!/usr/bin/env node

import { Command } from 'commander';
import commands from '../src/commands/index.js';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { ErrorHandler } from '../src/core/errors.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const packageJson = JSON.parse(readFileSync(join(__dirname, '../package.json'), 'utf8'));

const program = new Command();

program
  .name('specjet')
  .description('ğŸš€ SpecJet - API contract collaboration tool\nDesign APIs together, build separately, integrate seamlessly')
  .version(packageJson.version)
  .option('--verbose', 'Enable verbose output for debugging and error details')
  .option('--config <path>', 'Path to configuration file (default: ./specjet.config.js)')
  .addHelpText('after', `
Examples:
  $ specjet init my-api              Initialize a new project
  $ specjet generate                 Generate TypeScript types from contract
  $ specjet generate --watch        Generate and watch for changes
  $ specjet mock                    Start mock server on port 3001
  $ specjet mock --scenario large   Start mock server with large dataset  
  $ specjet docs                    Start documentation server on port 3002
  $ specjet docs --port 3003        Start docs server on custom port
  $ specjet validate http://api.com Validate real API against contract

Documentation:
  https://docs.specjet.dev

For more help on a specific command:
  $ specjet <command> --help
`);

// specjet init [project-name]
program
  .command('init')
  .description('ğŸ¯ Initialize a new SpecJet project with contract and configuration')
  .argument('[project-name]', 'Name of the project directory to create (default: current directory)')
  .option('--template <template>', 'Template to use: basic (default: basic)', 'basic')
  .option('--project <id>', 'Link to existing web platform project ID (future feature)')
  .option('--force', 'Overwrite existing files')
  .addHelpText('after', `
Examples:
  $ specjet init                    Initialize in current directory
  $ specjet init my-awesome-api     Create new project in ./my-awesome-api/
  $ specjet init --template basic  Use the basic template (default)

What this creates:
  â€¢ specjet.config.js     Configuration file
  â€¢ api-contract.yaml     OpenAPI contract template
  â€¢ src/types/            Generated TypeScript types (gitignored)
  â€¢ src/api/              Generated API client (gitignored)
`)
  .action(commands.init);

// specjet generate [options]
program
  .command('generate')
  .description('ğŸ”§ Generate TypeScript types and API client from OpenAPI contract')
  .option('-w, --watch', 'Watch mode - automatically regenerate when contract changes')
  .option('-o, --output <dir>', 'Custom output directory for generated files')
  .option('-c, --config <path>', 'Path to configuration file')
  .addHelpText('after', `
Examples:
  $ specjet generate                Generate once and exit
  $ specjet generate --watch       Generate and watch for changes
  $ specjet generate --output dist Custom output directory
Generated files:
  â€¢ src/types/api.ts      TypeScript interfaces for all schemas
  â€¢ src/api/client.ts     Typed API client with all endpoints

Watch mode:
  Automatically regenerates when your OpenAPI contract changes.
  Perfect for development workflows. Press Ctrl+C to stop watching.
`)
  .action(commands.generate);

// specjet mock [options]
program
  .command('mock')
  .description('ğŸ­ Start a local mock server with realistic API responses')
  .option('-p, --port <port>', 'Port to run mock server on (default: 3001)', '3001')
  .option('-s, --scenario <scenario>', 'Data scenario: demo|realistic|large|errors (default: demo)', 'demo')
  .option('-c, --config <path>', 'Path to configuration file')
  .addHelpText('after', `
Examples:
  $ specjet mock                        Start on port 3001 with demo data
  $ specjet mock --port 8080           Start on custom port
  $ specjet mock --scenario realistic  Use varied, realistic data
  $ specjet mock --scenario large      Use large datasets for performance testing
  $ specjet mock --scenario errors     Include error responses for testing

Data Scenarios:
  â€¢ demo       Small, predictable data perfect for demos and presentations
  â€¢ realistic  Varied, realistic data that mimics production usage patterns
  â€¢ large      Large datasets for performance and load testing
  â€¢ errors     Mix of successful and error responses for robust testing

Features:
  â€¢ ğŸŒ REST API endpoints based on your OpenAPI contract
  â€¢ ğŸš€ Fast, realistic mock responses using faker.js
  â€¢ ğŸŒ CORS headers always enabled for frontend development
  â€¢ ğŸ“Š Different data scenarios for comprehensive testing
  
  For API documentation, run: specjet docs --port 3002
`)
  .action(commands.mock);

// specjet docs [options]
program
  .command('docs')
  .description('ğŸ“– Start a beautiful documentation server for your API')
  .option('-p, --port <port>', 'Port to run documentation server on (default: 3002)')
  .option('--open', 'Automatically open documentation in browser')
  .option('-o, --output <file>', 'Generate static HTML file instead of starting server (e.g. docs.html)')
  .option('-c, --config <path>', 'Path to configuration file')
  .addHelpText('after', `
Examples:
  $ specjet docs                        Start documentation server on port 3002
  $ specjet docs --port 8080           Start on custom port  
  $ specjet docs --open                Start server and open in browser
  $ specjet docs --output docs.html    Generate static HTML file
  $ specjet docs --output ./dist/api-docs.html  Generate to custom path

Features:
  â€¢ ğŸ“– Beautiful single-page documentation with all endpoints
  â€¢ ğŸ¨ Dark/light theme toggle for comfortable viewing
  â€¢ ğŸ“‹ Clean sidebar navigation organized by endpoint categories  
  â€¢ ğŸ’» Copy-to-clipboard code examples (curl + TypeScript client)
  â€¢ ğŸ­ Mock data preview for each endpoint
  â€¢ ğŸ“± Responsive design that works on desktop and mobile
  â€¢ âš¡ Zero dependencies - works offline as a single HTML file

Documentation Features:
  â€¢ ğŸ“Š API overview with endpoint and schema statistics
  â€¢ ğŸ”— Complete endpoint documentation with parameters and responses
  â€¢ ğŸ“ Data model schemas with property descriptions and types
  â€¢ ğŸ¯ Smart code examples using your generated TypeScript client
  â€¢ ğŸ“‹ Clean mock response examples for development
`)
  .action(commands.docs);

// specjet validate <api-url>
program
  .command('validate')
  .description('ğŸ” Validate a real API implementation against your contract (coming soon)')
  .argument('<api-url>', 'Base URL of the API to validate (e.g., https://api.example.com)')
  .option('-H, --header <header>', 'HTTP header to include (can be used multiple times)')
  .option('--timeout <ms>', 'Request timeout in milliseconds (default: 5000)', '5000')
  .addHelpText('after', `
Examples:
  $ specjet validate http://localhost:8000
  $ specjet validate https://api.example.com
  $ specjet validate https://api.example.com --header "Authorization: Bearer token123"
  $ specjet validate https://api.example.com --header "X-API-Key: secret" --timeout 10000

What this validates:
  â€¢ Endpoint availability (all paths return expected status codes)
  â€¢ Response schema compliance (responses match OpenAPI schemas)  
  â€¢ Required fields presence (all required fields are present)
  â€¢ Data type correctness (field types match schema definitions)
  â€¢ HTTP method support (endpoints support specified methods)

Note: This feature is planned for a future release.
`)
  .action(commands.validate);

// specjet sync (Future)
program
  .command('sync')
  .description('ğŸ”„ Sync contract from web platform (coming in Phase 2)')
  .option('--force', 'Overwrite local changes without confirmation')
  .option('--project <id>', 'Project ID to sync from (overrides config)')
  .addHelpText('after', `
Examples:
  $ specjet sync                    Sync from linked project
  $ specjet sync --force           Overwrite local changes
  $ specjet sync --project proj_123 Sync from specific project

Note: This feature requires the SpecJet web platform (Phase 2).
      Currently, SpecJet CLI works with local OpenAPI files only.
`)
  .action(commands.sync);

// Handle uncaught exceptions and rejections
process.on('uncaughtException', (error) => {
  console.error('\nğŸš¨ Uncaught Exception:');
  ErrorHandler.handle(error, { verbose: program.opts().verbose });
  process.exit(1);
});

process.on('unhandledRejection', (reason) => {
  console.error('\nğŸš¨ Unhandled Promise Rejection:');
  ErrorHandler.handle(reason, { verbose: program.opts().verbose });
  process.exit(1);
});

program.parse();